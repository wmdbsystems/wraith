<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ghost // <%= location %></title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

  <script type="text/javascript" src="http://code.jquery.com/jquery-2.2.0.min.js"></script>
  <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.cycle/3.03/jquery.cycle.all.min.js"></script>
  <style type="text/css">
    body {
      position: relative;
      float: left;
      width: 100%;
    }

    .navbar-default {
      background-color: #f8f8f8;
      border: 0 none;
      border-bottom: 2px solid #ccc;
      border-radius: 0;
    }

    /* Sections */
    #footerSection {
      margin-bottom: 20px;
    }

    .slideshow, .slide, .next, .prev {
      height: 400px;
    }
    .slide {
      background-color: #FFF !important;
      width: 100% !important;
      margin: 0;
    }
    .next,
    .prev {
      cursor: pointer;
      background-color: #f5f5f5;
    }

    .prev span:before,
    .next span:before {
      font-size: 40px;
      display: block;
      font-family: "FontAwesome";
      margin-top: 173px;
    }

    .prev span:before {
      content:"\f0d9";
    }
    .next span:before {
      content:"\f0da";
    }

    .huge {
      font-size: 40px;
    }

    .progress {
      height: 30px;
    }

    .progress-bar {
      line-height: 30px;
    }

    .list-group-item {
      word-wrap: break-word;
      overflow: hidden;
      white-space: nowrap;
    }

    .list-group-item .text {
      width: 85%;
      display: inline-block;
      vertical-align: bottom;
      padding-left: 15px;
      overflow: hidden;
    }

    .list-group-item.checked .check-mark:after {
      color: rgba(128,128,128,1);
    }
    .list-group-item .check-mark {
      word-wrap: break-word;
      width: 95%;
      display: block;
    }
    .list-group-item .check-mark:after {
      content:"\f00c";
      font-family: "FontAwesome";
      color: rgba(128,128,128,0.3);
      position: absolute;
      right: 65px;
      bottom: 10px;
    }
    .checked a {
      color: #000;
    }
    .threshold {
      color: red;
    }
    .compare-modal {
      position:fixed;
      margin:0;
      top:0;
      left:0;
      width: 100%;
      height: 100%;
      background:rgba(0,0,0,0.7);
      overflow: scroll;
      z-index: 1000;
    }
    .compare-container {
      padding-bottom: 300px;
      z-index: 1000;
      margin-top: 20px;
      text-align: center;
    }
    .compare-container img{
      margin-right: 20px;
      max-width: 30%;
    }
    #screenshot.affix {
      right: 0;
      top: 15px;
    }

    #screenshot .panel {
      transition: all 0.3s linear;
    }
    #screenshot.affix .panel {
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
    }
    .modal-xl {
      width: auto;
      margin: 10px;
    }

  </style>
  <script type="text/javascript">
    $(function() {

      // Slideshow
      $('.slideshow').cycle({
        fx:     'fade',
        speed:  200,
        prev:   '.prev',
        next:   '.next',
        before: function (curr, next, opts) {
          $('.active').removeClass('active');
          var path = $(next).find('.path').attr('name');
          $.each($('.list-group .list-group-item'), function() {
            if ($(this).attr('href').substring(1) == path) {
              $(this).addClass('checked');
              $(this).addClass('active');
            }
          })
        },
        timeout: 0
      });

      // Page list
      $('.list-group .list-group-item').unbind().on('click', function(){
        var href = $(this).attr('href').substring(1);
        $('.slideshow').cycle($('.slide.'+href+':first').index());
      });

      // Thumbnail buttom
      $('.shot').unbind().on('click', function(e){
        e.preventDefault();
        var url = $(this).attr('href');
        window.open(url,'_blank');
      });

      // Filter pages
      $('#pagesAll a').on('click', function(){
        $('#page-list .list-group-item').show();
      });
      // Success
      $('#pagesSuccess a').on('click', function(){
        $('#page-list .list-group-item').hide();
        $('#page-list .list-group-item.list-group-item-success').show();
      });
      // Warning
      $('#pagesWarning a').on('click', function(){
        $('#page-list .list-group-item').hide();
        $('#page-list .list-group-item.list-group-item-warning').show();
      });
      // Danger
      $('#pagesDanger a').on('click', function(){
        $('#page-list .list-group-item').hide();
        $('#page-list .list-group-item.list-group-item-danger').show();
      });

      // Activate tooltip
      $('[data-toggle="tooltip"]').tooltip();


      // Bootstrap modal
      $('#compareModal').on('show.bs.modal', function (event) {
        var $button = $(event.relatedTarget),
            $modal = $(this),
            $slide = $button.closest('.slide');
        var pageTitle = $button.data('page-title'); // Extract info from data-* attributes
        var firstImage = $slide.find('a.shot:eq(0)').attr('href'),
            secondImage = $slide.find('a.shot:eq(1)').attr('href'),
            diffImage = $slide.find('a.shot:eq(2)').attr('href');

        $modal.find('#compareModalLabel').text(pageTitle);
        $modal.find('.firstImage').attr('src', firstImage);
        $modal.find('.secondImage').attr('src', secondImage);
        $modal.find('.diffImage').attr('src', diffImage);
      });

      // Affix
      $('#screenshot').affix({
        offset: {
          top: function () {
            navigationSectionHeight = $('#navigationSection').outerHeight(true);
            overviewSectionHeight = $('#overviewSection').outerHeight(true);
            return (this.top =  navigationSectionHeight + overviewSectionHeight - 15);
          },
          bottom: 0
        }
      });

    })
  </script>

</head>
<body>
<%

  # Count pages
  totalPagesCount = 0;
  failedPagesCount = 0;
  warningPagesCount = 0;
  passedPagesCount = 0;

  directories.each do |dir, sizes|
    sizes.to_a.sort.each do |size, files|
      totalPagesCount += 1
      if files[:data] > threshold
        failedPagesCount += 1
      else
        if files[:data] < threshold and files[:data] != 0
          warningPagesCount += 1
        else
          passedPagesCount += 1
        end
      end
    end
  end

  # Progress bar
  percentFailed = failedPagesCount.to_f / totalPagesCount * 100
  percentWarning = warningPagesCount.to_f / totalPagesCount * 100
  percentPassed = passedPagesCount.to_f / totalPagesCount * 100

  # Status label
  statusLabel = ''

  if failedPagesCount > 0
    statusLabel = 'label-danger'
    statusText = 'Failed'
  else if warningPagesCount > 0
    statusLabel = 'label-warning'
    statusText = 'Warning'
    else
      statusLabel = 'label-success'
      statusText = 'Passed'
    end
  end

%>
  <!-- Modal begin -->
  <div id="compareModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="compareModalLabel">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="compareModalLabel">Title</h4>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-sm-4">
              <img class="firstImage img-thumbnail" src="" alt=""/>
            </div>
            <div class="col-sm-4">
              <img class="secondImage img-thumbnail" src="" alt=""/>
            </div>
            <div class="col-sm-4">
              <img class="diffImage img-thumbnail" src="" alt=""/>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal end -->

  <!-- Navigation section begin -->
  <nav id="navigationSection" class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#">WMDB Ghost</a>
      </div>
      <div id="navbar" class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </nav>
  <!-- Navigation section end -->

  <!-- Overview section begin -->
  <div id="overviewSection" class="container-fluid">

    <!-- Summary begin -->
    <div class="row">
      <div class="col-sm-12">

        <h2>Project: <%= location %></h2>

        <dl class="dl-horizontal">
          <dt>Project</dt>
          <dd><%= location %></dd>
          <dt>Generated</dt>
          <dd><%= Time.now.strftime('%Y/%m/%d %H:%M:%S') %></dd>
          <dt>Duration</dt>
          <dd><del>12.13 minutes</del></dd>
          <dt>Threshold</dt>
          <dd><%= threshold %>%</dd>
          <dt>Status</dt>
          <dd><span id="status" class="label <%=statusLabel%> text-uppercase"><%=statusText%></span></dd>
        </dl>

        <hr>

      </div>
    </div>
    <!-- Summary end -->

    <!-- Status panels begin -->
    <div class="row">
      <div class="col-md-3 col-sm-6">
        <div class="panel panel-info" id="pagesAll">
          <div class="panel-heading">
            <div class="row">
              <div class="col-xs-3">
                <i class="fa fa-files-o fa-5x"></i>
              </div>
              <div class="col-xs-9 text-right">
                <div class="huge"><%= totalPagesCount %></div>
                <h5>Total Pages</h5>
              </div>
            </div>
          </div>
          <a href="javascript:;">
            <div class="panel-footer">
              <span class="pull-left">View All</span>
              <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
              <div class="clearfix"></div>
            </div>
          </a>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="panel panel-success" id="pagesSuccess">
          <div class="panel-heading">
            <div class="row">
              <div class="col-xs-3">
                <i class="fa fa-check fa-5x"></i>
              </div>
              <div class="col-xs-9 text-right">
                <div class="huge"><%= passedPagesCount %></div>
                <h5 class="text-uppercase"><span class="label label-success">Passed</span></h5>
              </div>
            </div>
          </div>
          <a href="javascript:;">
            <div class="panel-footer">
              <span class="pull-left">View Passed</span>
              <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
              <div class="clearfix"></div>
            </div>
          </a>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="panel panel-warning" id="pagesWarning">
          <div class="panel-heading">
            <div class="row">
              <div class="col-xs-3">
                <i class="fa fa-exclamation fa-5x"></i>
              </div>
              <div class="col-xs-9 text-right">
                <div class="huge"><%= warningPagesCount %></div>
                <h5 class="text-uppercase"><span class="label label-warning">Warning</span></h5>
              </div>
            </div>
          </div>
          <a href="javascript:;">
            <div class="panel-footer">
              <span class="pull-left">View Warning</span>
              <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
              <div class="clearfix"></div>
            </div>
          </a>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="panel panel-danger" id="pagesDanger">
          <div class="panel-heading">
            <div class="row">
              <div class="col-xs-3">
                <i class="fa fa-bolt fa-5x"></i>
              </div>
              <div class="col-xs-9 text-right">
                <div class="huge"><%= failedPagesCount %></div>
                <h5 class="text-uppercase"><span class="label label-danger">Failed</span></h5>
              </div>
            </div>
          </div>
          <a href="javascript:;">
            <div class="panel-footer">
              <span class="pull-left">View Failed</span>
              <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
              <div class="clearfix"></div>
            </div>
          </a>
        </div>
      </div>
    </div>
    <!-- Status panels end -->

    <!-- Progress bar begin -->
    <div class="progress">
      <div class="progress-bar progress-bar-success" style="width: <%= percentPassed %>%">
        <span class="text-uppercase">Passed <%= percentPassed.round %>%</span>
      </div>
      <div class="progress-bar progress-bar-warning" style="width: <%= percentWarning %>%">
        <span class="text-uppercase">Warning <%= percentWarning.round %>%</span>
      </div>
      <div class="progress-bar progress-bar-danger" style="width: <%= percentFailed %>%">
        <span class="text-uppercase">Failed <%= percentFailed.round %>%</span>
      </div>
    </div>
    <!-- Progress bar end -->

    <!-- Headline begin -->
    <div class="row">
      <div class="col-sm-12">
        <div class="page-header">
          <h3>Detail <small>Page results</small></h3>
        </div>
      </div>
    </div>
    <!-- Headline end -->

  </div>
  <!-- Overview section end -->

  <!-- Detail section begin -->
  <div id="detailSection" class="container-fluid">
    <div class="row">

      <!-- Pages panels begin -->
      <div class="col-sm-12 col-md-7">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title"><i class="fa fa-file"></i> Pages</h3>
          </div>

          <div id="page-list" class="list-group">
            <% directories.each do |dir, sizes| %>
            <% sizes.to_a.sort.each do |size, files| %>

            <% if files[:data] > threshold %>
            <a class="list-group-item list-group-item-danger" href="#<%=path%><%=dir%>">
              <span class="badge"><%=files[:data].ceil%>%</span>
              <span class="check-mark"></span>
              <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
              <span class="text"><%=dir.gsub('__', '/')%> <small>(<%=size%>px)</small></span>
            </a>
            <% else %>
            <% if files[:data] < threshold and files[:data] != 0 %>
            <a class="list-group-item list-group-item-warning" href="#<%=path%><%=dir%>">
              <span class="badge"><%=files[:data].ceil%>%</span>
              <span class="check-mark"></span>
              <span class="fa fa-exclamation" aria-hidden="true"></span>
              <span class="text"><%=dir.gsub('__', '/')%> <small>(<%=size%>px)</small></span>
            </a>
            <% else %>
            <a class="list-group-item list-group-item-success" href="#<%=path%><%=dir%>">
              <span class="badge"><%=files[:data].ceil%>%</span>
              <span class="check-mark"></span>
              <span class="fa fa-check" aria-hidden="true"></span>
              <span class="text"><%=dir.gsub('__', '/')%> <small>(<%=size%>px)</small></span>
            </a>
            <% end %>
            <% end %>

            <% end %>
            <% end %>
          </div>

        </div>
      </div>
      <!-- Pages panels end -->

      <!-- Sceenshot panels begin -->
      <div id="screenshot" class="hidden-xs hidden-sm col-md-5">

        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title"><i class="fa fa-video-camera"></i> Screenshot</h3>
          </div>
          <div class="panel-body">

            <div class=row">

              <div class="prev col-sm-1"><span></span></div>

              <div class="slideshow pull-left col-sm-10">
                <% directories.each do |dir, sizes| %>
                <% sizes.to_a.sort.each do |size, files| %>

                <div class="row slide <%= dir %>">

                  <a class="path" name="<%= dir %>"></a>

                  <div class="col-sm-12">
                    <h4>
                      Status (<%=size%>px)
                      <% if files[:data] > threshold %>
                      <span class="label label-danger text-uppercase">Failed</span>
                      <% else %>
                      <% if files[:data] < threshold and files[:data] != 0 %>
                      <span class="label label-warning text-uppercase">Warning</span>
                      <% else %>
                      <span class="label label-success text-uppercase">Passed</span>
                      <% end %>
                      <% end %>
                      <span class="label label-default text-uppercase"><%=files[:data]%>% Change</span>
                    </h4>
                    <br>
                  </div>

                  <% files[:variants].each do |file| %>
                  <div class="col-sm-4">
                    <a class="shot thumbnail" href="<%=file[:filename]%>" data-toggle="tooltip" data-placement="bottom" title="<%=file[:name]%>">
                      <img src="<%=path%><%=file[:thumb]%>">
                    </a>
                  </div>
                  <% end %>
                  <div class="col-sm-4">
                    <% if files[:diff] %>
                    <a class="shot thumbnail" href="<%=files[:diff][:filename]%>" data-toggle="tooltip" data-placement="bottom" title="Difference">
                      <img src="<%=path%><%=files[:diff][:thumb]%>">
                    </a>
                    <% end %>
                  </div>

                  <div class="col-sm-12">
                    <br>
                    <div class="well well-sm">
                      <a href="#<%=path%><%=dir%>"><i class="fa fa-link"></i> <%= dir.gsub('__', '/') %></a>
                    </div>
                    <button type="button" class="btn btn-primary btn-lg btn-block" data-toggle="modal" data-target="#compareModal" data-page-title="<%= dir.gsub('__', '/') %>"><i class="fa fa-files-o"></i> Compare</button>
                  </div>

                </div>
                <% end %>
                <% end %>
              </div>

              <div class="next col-sm-1"><span></span></div>

            </div>
          </div>
        </div>


      </div>
      <!-- Sceenshot panels end -->

    </div>
  </div>
  <!-- Detail section end -->

  <!-- Footer section begin -->
  <div id="footerSection" class="container-fluid">
    <div class="row">
      <div class="col-sm-12">
        <hr>
        <h5 class="text-center">WMDB Ghost</h5>
      </div>
    </div>
  </div>
  <!-- Footer section end -->

</body>
</html>
